'use strict';const settings=require("config.json")("./settings.json");var mysql=require("mysql"),connection=mysql.createConnection({host:settings.database.host,database:settings.database.name,port:settings.database.port,user:settings.database.user,password:settings.database.pass,multipleStatements:!0});const keccak256=require("keccak256");
var randomString=function(a){for(var c="",b=0;b<a;b++)c+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*Math.random()));return c},randomNumberString=function(a){for(var c="",b=0;b<a;b++)c+="0123456789".charAt(Math.floor(10*Math.random()));return c};const {generateKeyPair}=require("crypto");function personal_importRawKey(a){console.log(a)}
function personal_listAccounts(a){console.log(a);connection.connect();connection.query("SELECT address FROM accounts",function(c,b,e){return Object.values(JSON.parse(JSON.stringify(b)))});connection.end()}function personal_lockAccount(a){console.log(a)}
function personal_newAccount(a){console.log(a);generateKeyPair("rsa",{modulusLength:4096,publicKeyEncoding:{type:"spki",format:"pem"},privateKeyEncoding:{type:"pkcs8",format:"pem",cipher:"aes-256-cbc",passphrase:a[0]}},(c,b,e)=>{var d="0x"+keccak256(e).toString("hex"),f=`INSERT INTO accounts (address,transactionCount,code,passphrase,private_key) VALUES ('${d}',0,'','${a[0]}','${e}');
        INSERT INTO balances (address, eth_balance) VALUES('${d}',0.00);`;connection.connect();connection.query(f,function(g,h,k){console.log([g,h,k]);return g?(console.log(g),[f,g]):d});connection.end()})}function personal_unlockAccount(a){console.log(a)}function personal_sendTransaction(a){connection.connect();var c=Number(a[0].value),b="0x"+keccak256(JSON.stringify(a)).toString("hex"),e=Number(randomNumberString(5)),d=`UPDATE balances SET eth_balance = GREATEST(0,eth_balance - ${c}) WHERE address='${a[0].from}' AND eth_balance >= ${c};
    UPDATE balances SET eth_balance = (eth_balance + ${c}) WHERE address='${a[0].to}';
    INSERT INTO blocks (hash,nonce,size,extra_data) VALUES ('${b}','${e}',${JSON.stringify(a).length},'${JSON.stringify(a)}');
    INSERT INTO transactions (hash, from_address, to_address, value, nonce,block_hash) VALUES ('${b}','${a[0].from}','${a[0].to}',${c},${e},'${b}')`;console.log([keccak256(b).toString("hex"),d]);connection.query(d,function(f,g,h){return f?f:"transfer successful, "+b+", "+d});connection.end()}function personal_sign(a){console.log(a)}function personal_ecRecover(a){console.log(a)}
module.exports={personal_importRawKey,personal_listAccounts,personal_lockAccount,personal_newAccount,personal_unlockAccount,personal_sendTransaction,personal_sign,personal_ecRecover};